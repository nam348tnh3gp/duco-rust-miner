from flask import Flask, request, Response, jsonify
import requests
import logging
from urllib.parse import urlparse

# C·∫•u h√¨nh logging
logging.basicConfig(level=logging.INFO)

app = Flask(__name__)

class HTTPProxy:
    def __init__(self):
        self.session = requests.Session()
        # Gi·ªØ nguy√™n User-Agent ƒë·ªÉ m√¥ ph·ªèng thi·∫øt b·ªã di ƒë·ªông
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15'
        })
    
    def proxy_request(self, url, method='GET', headers=None, data=None):
        """Proxy HTTP request"""
        try:
            # Ch·ªâ cho ph√©p c√°c ph∆∞∆°ng th·ª©c an to√†n (safe methods) cho GET/image proxy
            if method.upper() not in ['GET', 'HEAD']:
                method = 'GET'
                
            response = self.session.request(
                method=method.upper(),
                url=url,
                headers=headers,
                data=data,
                timeout=30,
                allow_redirects=True
            )
            return {
                'success': True,
                'status_code': response.status_code,
                'content': response.content,
                'headers': dict(response.headers),
                'url': response.url
            }
        except Exception as e:
            logging.error(f"Error during proxy request to {url}: {e}")
            return {'success': False, 'error': str(e)}

proxy = HTTPProxy()

## C√°c endpoints hi·ªán c√≥ (Kh√¥ng thay ƒë·ªïi nhi·ªÅu, ch·ªâ th√™m /image_proxy v√†o danh s√°ch API)
# ---

@app.route('/')
def home():
    return '''
    <h1>üåê HTTP Proxy on Render.com</h1>
    <p><strong>D√†nh cho iPhone & Web Browser</strong></p>
    
    <h3>üì± C√°ch d√πng tr√™n iPhone:</h3>
    <ol>
        <li>V√†o <strong>Settings ‚Üí Wi-Fi</strong></li>
        <li>Ch·ªçn m·∫°ng Wi-Fi ‚Üí <strong>Configure Proxy</strong></li>
        <li>Ch·ªçn <strong>Auto</strong></li>
        <li>URL: <code>https://your-app.onrender.com/proxy.pac</code></li>
    </ol>

    <h3>üîß API Endpoints:</h3>
    <ul>
        <li><code>/proxy?url=https://example.com</code> - HTTP Proxy</li>
        <li><code>/get?url=https://example.com</code> - Get content</li>
        <li><strong><code>/image_proxy?url=https://example.com/image.jpg</code> - Proxy Image üñºÔ∏è</strong></li>
        <li><code>/ip</code> - Check IP address</li>
        <li><code>/proxy.pac</code> - Auto-config for iPhone</li>
    </ul>
    '''
    
@app.route('/proxy', methods=['GET', 'POST', 'PUT', 'DELETE'])
def http_proxy():
    """HTTP Proxy endpoint"""
    url = request.args.get('url')
    
    if not url:
        return jsonify({'error': 'Missing url parameter'}), 400
    
    # Get request details
    method = request.method
    headers = {key: value for key, value in request.headers if key.lower() not in ['host', 'content-length']}
    
    # Get request data
    request_data = request.get_data() if request.get_data() else None
    
    result = proxy.proxy_request(url, method, headers, request_data)
    
    if not result['success']:
        return jsonify({'error': result['error']}), 500
    
    # Return response
    response = Response(
        result['content'],
        status=result['status_code']
    )
    
    # Copy headers
    for key, value in result['headers'].items():
        if key.lower() not in ['content-encoding', 'transfer-encoding', 'content-length']:
            response.headers[key] = value
    
    return response

@app.route('/get')
def get_content():
    """Get website content"""
    url = request.args.get('url')
    if not url:
        return jsonify({'error': 'Missing url parameter'}), 400
    
    result = proxy.proxy_request(url)
    
    if not result['success']:
        return jsonify({'error': result['error']}), 500
    
    return jsonify({
        'url': result['url'],
        'status_code': result['status_code'],
        'content_length': len(result['content']),
        'content_preview': result['content'][:500].decode('utf-8', errors='ignore') + '...'
    })

# --- Endpoint M·ªöI ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh ---

@app.route('/image_proxy')
def image_proxy():
    """Endpoint ƒë·ªÉ proxy v√† hi·ªÉn th·ªã ·∫£nh"""
    image_url = request.args.get('url')
    
    if not image_url:
        return jsonify({'error': 'Missing url parameter'}), 400
    
    logging.info(f"Proxying image from: {image_url}")
    
    # G·ªçi h√†m proxy_request. Ch·ªâ c·∫ßn GET
    result = proxy.proxy_request(image_url, method='GET')
    
    if not result['success']:
        logging.error(f"Failed to proxy image {image_url}: {result['error']}")
        return jsonify({'error': f"Failed to fetch image: {result['error']}"}), 500

    # Ki·ªÉm tra Content-Type ƒë·ªÉ x√°c nh·∫≠n ƒë√≥ l√† ·∫£nh v√† l·∫•y MIME type
    content_type = result['headers'].get('Content-Type')
    
    # Ki·ªÉm tra ƒë∆°n gi·∫£n: n·∫øu Content-Type kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng 'image/', tr·∫£ l·ªói
    if not content_type or not content_type.startswith('image/'):
        logging.warning(f"URL {image_url} did not return an image content type: {content_type}")
        return jsonify({'error': f'URL does not point to an image. Content-Type: {content_type}'}), 415 # 415 Unsupported Media Type

    # Tr·∫£ v·ªÅ Response
    response = Response(
        result['content'],
        status=result['status_code'],
        mimetype=content_type # Thi·∫øt l·∫≠p MIME type ƒë·ªÉ tr√¨nh duy·ªát hi·ªÉn th·ªã ·∫£nh
    )
    
    # Sao ch√©p c√°c header quan tr·ªçng (v√≠ d·ª•: Cache-Control)
    for key, value in result['headers'].items():
        key_lower = key.lower()
        if key_lower not in ['content-encoding', 'transfer-encoding', 'content-length', 'content-type']:
            response.headers[key] = value
            
    return response

# ---

@app.route('/ip')
def get_ip():
    """Get client IP"""
    test_urls = [
        'http://httpbin.org/ip',
        'http://api.ipify.org?format=json',
    ]
    
    results = {}
    for test_url in test_urls:
        result = proxy.proxy_request(test_url)
        if result['success']:
            results[test_url] = result['content'].decode('utf-8')
        else:
            results[test_url] = f'Error: {result["error"]}'
    
    return jsonify({
        'your_ip': request.headers.get('X-Forwarded-For', request.remote_addr),
        'proxy_server': 'Render.com HTTP Proxy',
        'results': results
    })

@app.route('/proxy.pac')
def proxy_pac():
    """PAC file for iPhone auto-config"""
    pac_script = '''
    function FindProxyForURL(url, host) {
        // Proxy t·∫•t c·∫£ traffic qua HTTP Proxy
        return "PROXY %s:443; DIRECT";
    }
    ''' % request.host
    
    return Response(pac_script, mimetype='application/x-ns-proxy-autoconfig')

@app.route('/test')
def test():
    """Test proxy functionality"""
    test_url = 'http://httpbin.org/ip'
    result = proxy.proxy_request(test_url)
    
    return jsonify({
        'proxy_server': 'Render.com HTTP Proxy',
        'test_url': test_url,
        'success': result['success'],
        'your_ip': result['content'].decode('utf-8') if result['success'] else result['error']
    })

if __name__ == '__main__':
    import os
    port = int(os.environ.get('PORT', 5000))
    # ƒê·∫∑t debug=True n·∫øu ch·∫°y c·ª•c b·ªô ƒë·ªÉ d·ªÖ ph√°t tri·ªÉn
    app.run(host='0.0.0.0', port=port, debug=False)
